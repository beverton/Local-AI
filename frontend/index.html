<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local AI - Ihr pers√∂nlicher AI-Assistent</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="pipeline_editor.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>Local AI</h1>
                <button class="btn-new-chat" id="btnNewChat">+ Neues Gespr√§ch</button>
                <button class="btn-new-image" id="btnNewImage" style="width: 100%; margin-top: 10px; padding: 10px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">üñºÔ∏è Neues Bild</button>
                <button class="btn-pipeline" id="btnPipeline" style="width: 100%; margin-top: 10px; padding: 10px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">üîó Pipeline Editor</button>
            </div>
            
            <div class="conversations-list" id="conversationsList">
                <div class="loading">Lade Gespr√§che...</div>
            </div>
            
            <div class="sidebar-footer">
                <div class="model-service-status" id="modelServiceStatus" style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 10px;">
                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500;">Model-Service Status</div>
                    <div class="model-status-item" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 0.9em;">
                        <span>Text:</span>
                        <span id="modelStatusText" style="color: var(--text-secondary);">-</span>
                    </div>
                    <div class="model-status-item" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 0.9em;">
                        <span>Audio:</span>
                        <span id="modelStatusAudio" style="color: var(--text-secondary);">-</span>
                    </div>
                    <div class="model-status-item" style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9em;">
                        <span>Bild:</span>
                        <span id="modelStatusImage" style="color: var(--text-secondary);">-</span>
                    </div>
                </div>
                
                <div class="system-stats" id="systemStats">
                    <div class="stat-item">
                        <span class="stat-label">CPU:</span>
                        <span class="stat-value" id="cpuPercent">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">RAM:</span>
                        <span class="stat-value" id="ramPercent">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">GPU:</span>
                        <span class="stat-value" id="gpuPercent">-</span>
                    </div>
                </div>
                
                <div class="settings-toggle">
                    <button class="btn-settings" id="btnSettings">‚öôÔ∏è Einstellungen</button>
                    <button class="btn-restart" id="btnRestart" style="width: 100%; margin-top: 10px; padding: 10px; background: var(--warning, #e67e22); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">üîÑ Server neu starten</button>
                </div>
            </div>
        </aside>
        
        <!-- Main Chat Area -->
        <main class="chat-container">
            <div class="chat-header">
                <div class="header-left">
                    <h2 id="chatTitle">Neues Gespr√§ch</h2>
                </div>
                <div class="header-right">
                    <div class="status-indicators" id="statusIndicators" style="display: flex; flex-direction: column; gap: 5px; align-items: flex-end;">
                        <div class="status-indicator" id="statusTextModel" style="display: none;">
                            <span class="status-dot" style="background: var(--accent);"></span>
                            <span class="status-label">Text:</span>
                            <span class="status-value" id="statusTextValue">Bereit</span>
                        </div>
                        <div class="status-indicator" id="statusImageModel" style="display: none;">
                            <span class="status-dot" style="background: #9b59b6;"></span>
                            <span class="status-label">Bild:</span>
                            <span class="status-value" id="statusImageValue">-</span>
                        </div>
                        <div class="status-indicator" id="statusAudioModel" style="display: none;">
                            <span class="status-dot" style="background: #e67e22;"></span>
                            <span class="status-label">Audio:</span>
                            <span class="status-value" id="statusAudioValue">-</span>
                        </div>
                        <!-- Fallback f√ºr alte Statusanzeige -->
                        <div class="status-indicator" id="statusIndicator" style="display: none;">
                            <span class="status-dot"></span>
                            <span id="statusText">Bereit</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="welcome-message">
                    <h3>Willkommen bei Local AI</h3>
                    <p>Stellen Sie eine Frage oder starten Sie ein Gespr√§ch.</p>
                </div>
            </div>
            
            <div class="chat-input-container" id="chatInputContainer">
                <div class="file-upload-area" id="fileUploadArea">
                    <input type="file" id="fileInput" accept=".csv,.txt,.json" style="display: none;" multiple>
                    <button class="btn-upload" id="btnUpload" title="Datei hochladen">üìé</button>
                    <button class="btn-microphone" id="btnMicrophone" title="Spracheingabe">üé§</button>
                    <button class="btn-agent-mode" id="btnAgentMode" title="Agent-Modus (WebSearch & Dateimanipulation)">ü§ñ</button>
                    <div class="uploaded-files" id="uploadedFiles"></div>
                </div>
                <div class="input-wrapper">
                    <textarea 
                        id="messageInput" 
                        placeholder="Nachricht eingeben... (Enter zum Senden, Shift+Enter f√ºr neue Zeile)"
                        rows="1"
                    ></textarea>
                    <button class="btn-send" id="btnSend" disabled>‚û§</button>
                    <button class="btn-cancel" id="btnCancel" style="display: none;">‚úï Abbrechen</button>
                </div>
            </div>
            
            <div class="image-input-container" id="imageInputContainer" style="display: none;">
                <div class="image-size-mode" style="margin-bottom: 10px;">
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--text-secondary);">Gr√∂√üen-Modus:</label>
                    <div style="display: flex; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="imageSizeMode" id="imageSizeModeRatio" value="ratio" checked>
                            <span>Aspect Ratio</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="imageSizeMode" id="imageSizeModeCustom" value="custom">
                            <span>Custom Size</span>
                        </label>
                    </div>
                </div>
                
                <!-- Ratio-Modus -->
                <div id="ratioModeContainer" style="margin-bottom: 10px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <label for="imageResolutionPreset" style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--text-secondary);">Aufl√∂sung:</label>
                            <select id="imageResolutionPreset" class="model-select" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary);">
                                <option value="l">L (1024px)</option>
                                <option value="m">M (720px)</option>
                                <option value="s">S (512px)</option>
                            </select>
                        </div>
                        <div>
                            <label for="imageAspectRatio" style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--text-secondary);">Aspect Ratio:</label>
                            <select id="imageAspectRatio" class="model-select" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary);">
                                <option value="1:1">1:1 (Quadrat)</option>
                                <option value="16:9">16:9 (Breit)</option>
                                <option value="9:16">9:16 (Hoch)</option>
                                <option value="4:3">4:3 (Standard)</option>
                                <option value="3:4">3:4 (Portrait)</option>
                                <option value="custom">Custom Ratio</option>
                            </select>
                        </div>
                    </div>
                    <div id="customRatioContainer" style="display: none; margin-bottom: 10px;">
                        <label for="customRatioW" style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--text-secondary);">Custom Ratio (W:H):</label>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <input type="number" id="customRatioW" placeholder="W" min="0.1" max="10" step="0.1" style="flex: 1; padding: 8px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary);">
                            <span>:</span>
                            <input type="number" id="customRatioH" placeholder="H" min="0.1" max="10" step="0.1" style="flex: 1; padding: 8px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary);">
                        </div>
                    </div>
                    <div style="font-size: 0.85em; color: var(--text-secondary); padding: 8px; background: var(--bg-tertiary); border-radius: 8px;">
                        <span id="ratioPreview">Dimensionen: 1024 x 1024 px</span>
                    </div>
                </div>
                
                <!-- Custom Size-Modus -->
                <div id="customSizeModeContainer" style="display: none; margin-bottom: 10px;">
                    <div class="image-dimensions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label for="imageWidth" style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--text-secondary);">Breite (px):</label>
                            <input type="number" id="imageWidth" value="1024" min="256" max="2048" step="8" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary);">
                        </div>
                        <div>
                            <label for="imageHeight" style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--text-secondary);">H√∂he (px):</label>
                            <input type="number" id="imageHeight" value="1024" min="256" max="2048" step="8" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary);">
                        </div>
                    </div>
                </div>
                <div class="image-input-wrapper">
                    <textarea 
                        id="imagePromptInput" 
                        placeholder="Beschreiben Sie das Bild, das Sie generieren m√∂chten..."
                        rows="1"
                    ></textarea>
                    <div class="image-controls">
                        <button class="btn-generate-image" id="btnGenerateImage" disabled>üé® Bild generieren</button>
                        <button class="btn-cancel" id="btnCancelImage" style="display: none;">‚úï Abbrechen</button>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Settings Panel (overlay) -->
        <div class="settings-panel" id="settingsPanel">
            <div class="settings-content">
                <div class="settings-header">
                    <h2>Einstellungen</h2>
                    <button class="btn-close" id="btnCloseSettings">√ó</button>
                </div>
                
                <div class="settings-section">
                    <h3>Preference Learning</h3>
                    <div class="toggle-container">
                        <label class="toggle">
                            <input type="checkbox" id="preferenceToggle">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">Aus Interaktionen lernen</span>
                    </div>
                    <p class="setting-description">
                        Die AI passt sich an Ihre Pr√§ferenzen an (Stil, Themen, etc.)
                    </p>
                    <button class="btn-reset" id="btnResetPreferences">Pr√§ferenzen zur√ºcksetzen</button>
                </div>
                
                <div class="settings-section">
                    <h3>Modell</h3>
                    <div class="setting-item">
                        <label for="conversationModelSelect">Modell f√ºr diese Conversation:</label>
                        <select id="conversationModelSelect" class="model-select" style="width: 100%; padding: 8px; margin-top: 5px;">
                            <option value="">Globales Modell verwenden</option>
                        </select>
                        <p class="setting-description">
                            W√§hlen Sie ein spezifisches Modell f√ºr diese Conversation. Wenn kein Modell ausgew√§hlt ist, wird das globale Modell verwendet.
                        </p>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Generierung</h3>
                    <div class="setting-item">
                        <label for="temperatureSlider">Temperature: <span id="temperatureValue">0.3</span></label>
                        <input type="range" id="temperatureSlider" min="0" max="1" step="0.1" value="0.3">
                        <p class="setting-description">Kreativit√§t der Antworten (0 = konservativ, 1 = kreativ)</p>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Audio / Spracherkennung</h3>
                    <div class="setting-item">
                        <label for="transcriptionLanguageSelect">Ausgabesprache f√ºr Transkription:</label>
                        <select id="transcriptionLanguageSelect" class="model-select" style="width: 100%; padding: 8px; margin-top: 5px;">
                            <option value="">Auto (Sprache automatisch erkennen)</option>
                            <option value="de">Deutsch</option>
                            <option value="en">Englisch</option>
                            <option value="fr">Franz√∂sisch</option>
                            <option value="es">Spanisch</option>
                            <option value="it">Italienisch</option>
                            <option value="pt">Portugiesisch</option>
                            <option value="ru">Russisch</option>
                            <option value="ja">Japanisch</option>
                            <option value="zh">Chinesisch</option>
                            <option value="ko">Koreanisch</option>
                            <option value="ar">Arabisch</option>
                            <option value="nl">Niederl√§ndisch</option>
                            <option value="pl">Polnisch</option>
                            <option value="tr">T√ºrkisch</option>
                            <option value="sv">Schwedisch</option>
                            <option value="no">Norwegisch</option>
                            <option value="da">D√§nisch</option>
                            <option value="fi">Finnisch</option>
                            <option value="cs">Tschechisch</option>
                            <option value="hu">Ungarisch</option>
                            <option value="ro">Rum√§nisch</option>
                            <option value="el">Griechisch</option>
                            <option value="he">Hebr√§isch</option>
                            <option value="hi">Hindi</option>
                            <option value="th">Thail√§ndisch</option>
                            <option value="vi">Vietnamesisch</option>
                            <option value="id">Indonesisch</option>
                            <option value="ms">Malaiisch</option>
                            <option value="uk">Ukrainisch</option>
                            <option value="bg">Bulgarisch</option>
                            <option value="hr">Kroatisch</option>
                            <option value="sk">Slowakisch</option>
                            <option value="sl">Slowenisch</option>
                            <option value="sr">Serbisch</option>
                            <option value="et">Estnisch</option>
                            <option value="lv">Lettisch</option>
                            <option value="lt">Litauisch</option>
                            <option value="ca">Katalanisch</option>
                            <option value="eu">Baskisch</option>
                            <option value="ga">Irisch</option>
                            <option value="cy">Walisisch</option>
                            <option value="mt">Maltesisch</option>
                            <option value="is">Isl√§ndisch</option>
                        </select>
                        <p class="setting-description">
                            W√§hlen Sie die Ausgabesprache f√ºr Audio-Transkriptionen. Wenn "Auto" gew√§hlt ist, wird die Sprache automatisch erkannt. Sie k√∂nnen auf Deutsch sprechen und die Ausgabe in Englisch erhalten (oder umgekehrt).
                        </p>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Model Manager</h3>
                    <button class="btn-model-manager" id="btnModelManager" style="width: 100%; padding: 10px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; margin-bottom: 10px;">üîß Model Manager √∂ffnen</button>
                    <p class="setting-description">
                        √ñffnet den separaten Model Manager (l√§uft unabh√§ngig vom Server)
                    </p>
                </div>
                
                <div class="settings-section">
                    <h3>üìÅ Output-Pfade</h3>
                    <div class="setting-item">
                        <label for="outputBaseDirectory">Basis-Verzeichnis:</label>
                        <input type="text" id="outputBaseDirectory" placeholder="G:\KI Modelle\Outputs" style="width: 100%; padding: 8px; margin-top: 5px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary);">
                        <p class="setting-description">
                            Hauptverzeichnis f√ºr alle generierten Ausgaben
                        </p>
                    </div>
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="outputUseDateFolders">
                            <span style="margin-left: 8px;">Datum-Ordner verwenden (YYYY-MM-DD)</span>
                        </label>
                        <p class="setting-description">Organisiert Ausgaben automatisch nach Datum</p>
                    </div>
                    <div class="setting-item">
                        <label for="outputFilenameFormat">Dateiname-Format:</label>
                        <input type="text" id="outputFilenameFormat" placeholder="{date}_{title}" value="{date}_{title}" style="width: 100%; padding: 8px; margin-top: 5px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary);">
                        <p class="setting-description">
                            Verf√ºgbare Platzhalter: {date}, {title}<br>
                            Beispiel: {date}_{title} ‚Üí 20260107_123456_A_beautiful_sunset
                        </p>
                    </div>
                    <div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px; font-size: 0.85em; margin-top: 10px;">
                        <div style="margin-bottom: 5px;"><strong>Unterordner:</strong></div>
                        <div style="color: var(--text-secondary);">
                            üì∑ Bilder: generated_images/<br>
                            üí¨ Gespr√§che: conversations/<br>
                            üé§ Audio: audio/
                        </div>
                    </div>
                    <button class="btn-reset" id="btnApplyOutputSettings" style="margin-top: 10px;">Output-Einstellungen anwenden</button>
                    <button class="btn-reset" id="btnOpenOutputFolder" style="margin-top: 10px; background: var(--accent);">üìÇ Output-Ordner √∂ffnen</button>
                </div>
                
                <div class="settings-section">
                    <h3>Performance</h3>
                    <div class="setting-item">
                        <label for="cpuThreadsSlider">CPU Threads: <span id="cpuThreadsValue">Auto</span></label>
                        <input type="range" id="cpuThreadsSlider" min="1" max="16" step="1" value="0">
                        <p class="setting-description">Anzahl CPU-Threads (0 = Auto, mehr = schneller aber mehr CPU-Auslastung)</p>
                    </div>
                    <div class="setting-item">
                        <label for="gpuOptimizationSelect">GPU Optimierung:</label>
                        <select id="gpuOptimizationSelect" class="model-select" style="width: 100%; padding: 8px; margin-top: 5px;">
                            <option value="balanced">Ausgewogen (Standard)</option>
                            <option value="speed">Maximale Geschwindigkeit</option>
                            <option value="memory">Speicher-effizient</option>
                        </select>
                        <p class="setting-description">Geschwindigkeit vs. Speicherverbrauch (nur bei GPU)</p>
                    </div>
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="disableCpuOffload">
                            <span style="margin-left: 8px;">CPU-Offloading deaktivieren (mehr GPU-Nutzung)</span>
                        </label>
                        <p class="setting-description">Deaktiviert automatisches CPU-Offloading f√ºr maximale GPU-Auslastung</p>
                    </div>
                    <button class="btn-reset" id="btnApplyPerformance" style="margin-top: 10px;">Performance-Einstellungen anwenden</button>
                    <p class="setting-description" style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                        Hinweis: √Ñnderungen werden beim n√§chsten Modell-Laden wirksam
                    </p>
                </div>
                
                <div class="settings-section">
                    <h3>Quality Management</h3>
                    <div class="toggle-container">
                        <label class="toggle">
                            <input type="checkbox" id="qualityWebValidation">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">Web-Validierung</span>
                    </div>
                    <p class="setting-description">Validiert Antworten gegen Web-Quellen</p>
                    
                    <div class="toggle-container">
                        <label class="toggle">
                            <input type="checkbox" id="qualityContradictionCheck">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">Widerspruchspr√ºfung</span>
                    </div>
                    <p class="setting-description">Pr√ºft auf Widerspr√ºche zwischen Quellen</p>
                    
                    <div class="toggle-container">
                        <label class="toggle">
                            <input type="checkbox" id="qualityHallucinationCheck">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">Halluzinations-Erkennung</span>
                    </div>
                    <p class="setting-description">Erkennt Fakten die nicht in Quellen stehen</p>
                    
                    <div class="toggle-container">
                        <label class="toggle">
                            <input type="checkbox" id="qualityAutoWebSearch">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">Automatischer Web-Search</span>
                    </div>
                    <p class="setting-description">F√ºhrt automatisch Web-Suche f√ºr Fragen durch</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pipeline Editor Window (separates Fenster) -->
    <div id="pipelineEditorWindow" class="pipeline-editor-window" style="display: none;">
        <div class="pipeline-editor-header">
            <h2>Pipeline Editor</h2>
            <button id="btnClosePipelineEditor" class="btn-close">√ó</button>
        </div>
        <div class="pipeline-editor-content">
            <div class="pipeline-toolbar">
                <button id="btnAddPromptAgent" class="btn-add-agent">+ Prompt Agent</button>
                <button id="btnAddImageAgent" class="btn-add-agent">+ Image Agent</button>
                <button id="btnAddVisionAgent" class="btn-add-agent">+ Vision Agent</button>
                <button id="btnRunPipeline" class="btn-run-pipeline">‚ñ∂ Pipeline ausf√ºhren</button>
            </div>
            <div id="pipelineCanvas" class="pipeline-canvas"></div>
            <div class="pipeline-input">
                <label>Initialer Input:</label>
                <textarea id="pipelineInput" placeholder="Geben Sie den initialen Input ein..."></textarea>
            </div>
        </div>
    </div>
    
    <script src="app.js"></script>
    <script src="pipeline_editor.js"></script>
</body>
</html>

